# CRITICAL BUG FOUND AND FIXED ðŸŽ¯

## The Bug

**File**: `web_app.py:37`
**Problem**: PREVIEWS_FOLDER was using a relative path

### Before (BROKEN):
```python
PREVIEWS_FOLDER = Path('previews')
```

### After (FIXED):
```python
PREVIEWS_FOLDER = Path(__file__).parent / 'previews'  # Absolute path for Photoshop
```

## Why This Broke Thumbnails

When Photoshop executes ExtendScript, it uses its OWN working directory (probably `/Applications/Adobe Photoshop 2026/`), not Flask's working directory.

### What Happened:
1. Flask passed **relative path** `"previews"` to ThumbnailService
2. ThumbnailService generated ExtendScript with:
   ```javascript
   var outputFolder = new Folder("previews/thumbnails/session_id");
   ```
3. Photoshop looked for `previews/` relative to `/Applications/Adobe Photoshop 2026/`
4. **Directory didn't exist** in Photoshop's location
5. Thumbnails failed to save
6. Results JSON was empty
7. Frontend got 0 thumbnails

### What Should Happen:
1. Flask passes **absolute path** `/Users/edf/aftereffects-automation/previews`
2. ThumbnailService generates ExtendScript with:
   ```javascript
   var outputFolder = new Folder("/Users/edf/aftereffects-automation/previews/thumbnails/session_id");
   ```
3. Photoshop can find and write to this location
4. Thumbnails save successfully
5. Results JSON contains all 6 thumbnails
6. Frontend displays them

## Why Test Script Worked

The test script (`test_photoshop_thumbnails.py`) used:
```python
OUTPUT_FOLDER = "/tmp/thumb_test"  # ABSOLUTE PATH
```

So it always worked!

## The Fix Was Simple

Just change relative `Path('previews')` to absolute `Path(__file__).parent / 'previews'`

This makes the path relative to `web_app.py`'s location, which becomes:
`/Users/edf/aftereffects-automation/previews`

## How We Found It

1. **Added comprehensive logging** to `services/thumbnail_service.py`
2. **Examined the ExtendScript** generated by production code
3. **Noticed**: `var outputFolder = new Folder("previews/thumbnails/...")`
4. **Realized**: This is a RELATIVE path!
5. **Compared**: Test script uses absolute `/tmp/thumb_test`
6. **Root cause**: PREVIEWS_FOLDER in web_app.py was relative

## Verification

After the fix, the logs should show:
```
Thumbnail folder: /Users/edf/aftereffects-automation/previews/thumbnails/session_id
```

And the ExtendScript should contain:
```javascript
var outputFolder = new Folder("/Users/edf/aftereffects-automation/previews/thumbnails/...");
```

## Impact

- âœ… Production thumbnail generation will now work
- âœ… Photoshop can find the output directory
- âœ… Thumbnails will save successfully
- âœ… Frontend will receive and display all thumbnails
- âœ… Test viewer will show production thumbnails

## Testing

1. **Restart Flask** (if not using auto-reload)
2. **Visit**: http://localhost:5001
3. **Upload PSD and AEPX**
4. **Click "Load Visual Previews"**
5. **Check Flask logs** - should see absolute path in ExtendScript
6. **Check browser console** - should see 6 thumbnails
7. **Verify thumbnails display** in the visual mapper

## Files Modified

- `web_app.py:37` - Changed PREVIEWS_FOLDER to absolute path

## Related Logging

The comprehensive diagnostic logging added will show:
- Input paths (PSD, output folder)
- Generated ExtendScript content
- AppleScript execution results
- Results file content
- Parsed thumbnails dictionary

This makes future debugging much easier!

## Summary

A single-line change from relative to absolute path fixes the entire thumbnail generation system. The ExtendScript generation code was correct all along - it was just being given the wrong base path!
